<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
	http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd">

	<!-- Access FreeMarker bean wrapper so that we can pass Enums to FTL templates -->
	<bean id="freemarkerWrapper" class="freemarker.ext.beans.BeansWrapper" factory-method="getDefaultInstance" />
	<bean id="freemarkerEnumModels" factory-bean="freemarkerWrapper" factory-method="getEnumModels" />

	<bean id="freemarkerConfiguration" class="org.springframework.ui.freemarker.FreeMarkerConfigurationFactoryBean">
 		<property name="templateLoaderPaths">
			<list>
				<value>file:#{searchHome.absolutePath}/</value>
				<value>/WEB-INF/freemarker/</value>
			</list>
		</property>
		<property name="freemarkerSettings">
			<props>
				<prop key="url_escaping_charset">UTF-8</prop>
			</props>
		</property>
		<property name="defaultEncoding" value="UTF-8" />
		<property name="freemarkerVariables">
			<map>
				<!-- Provide a logger within form files -->
				<entry key="#{T(com.funnelback.publicui.search.web.controllers.SearchController$ModelAttributes).Log.toString()}">
					<bean class="org.apache.log4j.Logger" factory-method="getLogger">
						<constructor-arg type="java.lang.String" value="com.funnelback.form" />
					</bean>
				</entry>
				<entry
					key="#{T(com.funnelback.publicui.search.web.controllers.SearchController$ModelAttributes).SearchPrefix.toString()}"
					value="#{appProperties['urls.search.prefix']}" />
				<entry
					key="#{T(com.funnelback.publicui.search.web.controllers.SearchController$ModelAttributes).ContextPath.toString()}"
					value="#{executionContextHolder.contextPath}" />
				<entry key="ExtraSearches">
					<bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
						<property name="targetObject">
							<ref local="freemarkerEnumModels" />
						</property>
						<property name="targetMethod">
							<value>get</value>
						</property>
						<property name="arguments">
							<list>
								<value>com.funnelback.publicui.search.model.transaction.SearchTransaction$ExtraSearches</value>
							</list>
						</property>
					</bean>
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.ChangeQSParamMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.ChangeQSParamMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.RemoveQSParamMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.RemoveQSParamMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.FacetScopeRemoveMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.FacetScopeRemoveMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.IsEnabledMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.IsEnabledMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.TruncateMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.TruncateMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.TruncateHTMLMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.TruncateHTMLMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.TruncateURLMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.TruncateURLMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.TagifyMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.TagifyMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.IncludeUrlDirective).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.IncludeUrlDirective">
						<constructor-arg ref="appCacheManager" />
						<constructor-arg ref="i18n"></constructor-arg>
					</bean>
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.IsAdminUIMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.IsAdminUIMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.ParseRangeMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.ParseRangeMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.ParseRelativeDateMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.ParseRelativeDateMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.SearchMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.SearchMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.HTMLDecodeMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.HTMLDecodeMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.URLDecodeMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.URLDecodeMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.CurrentDateMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.CurrentDateMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.UpdatedDateMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.UpdatedDateMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.FormListMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.FormListMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.FacetedNavigationConfigMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.FacetedNavigationConfigMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.FilesizeFormatMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.FilesizeFormatMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.ResolveUrlMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.ResolveUrlMethod" />
				</entry>
				<entry key="#{T(com.funnelback.publicui.search.web.views.freemarker.FormatMethod).NAME}">
					<bean class="com.funnelback.publicui.search.web.views.freemarker.FormatMethod" />
				</entry>
			</map>
		</property>
	</bean>
	
	<bean id="freemarkerConfig" class="org.springframework.web.servlet.view.freemarker.FreeMarkerConfigurer">
   		<property name="configuration" ref="freemarkerConfiguration" />
	</bean>

	<!-- Customise FreeMarker Exception handling -->
	<bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
		<property name="targetObject" ref="freemarkerConfiguration" />
		<property name="targetMethod" value="setTemplateExceptionHandler" />
		<property name="arguments">
			<array>
				<ref bean="defaultTemplateExceptionHandler" />
			</array>
		</property>
 	</bean>
 	
 	<!-- Customise arithmetic engine so that numbers expressed in the templates are converted
 	     into their smallest possible representation instead of BigDecimal. This is needed because
 	     otherwise the @fb.Format tag doesn't know how to format BigDecimals -->
	<bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
		<property name="targetObject" ref="freemarkerConfiguration" />
		<property name="targetMethod" value="setArithmeticEngine" />
		<property name="arguments" value="#{T(freemarker.core.ArithmeticEngine).CONSERVATIVE_ENGINE}" />
 	</bean>
	
	<!-- Specific view for OpenSearch controller. It needs a specific configuration as it outputs XML and not HTML -->
	<bean class="org.springframework.web.servlet.view.freemarker.FreeMarkerView" id="openSearchView">
		<property name="url" value="open-search.ftl" />
		<property name="contentType" value="text/xml;charset=UTF-8" />
	</bean>

	<!-- Auto-completion views -->
	<bean class="org.springframework.web.servlet.view.freemarker.FreeMarkerView" id="suggestViewSimple">
		<property name="url" value="suggest/simple.ftl" />
		<property name="contentType" value="application/json;charset=UTF-8" />
	</bean>
	<bean class="org.springframework.web.servlet.view.freemarker.FreeMarkerView" id="suggestViewRich">
		<property name="url" value="suggest/rich.ftl" />
		<property name="contentType" value="application/json;charset=UTF-8" />
	</bean>

	<bean class="org.springframework.web.servlet.view.freemarker.FreeMarkerView" name="contentOptimiserView">
		<property name="url" value="contentoptimiser/content-optimiser.ftl" />
		<property name="contentType" value="text/html;charset=UTF-8" />
	</bean>

	<bean class="org.springframework.web.servlet.view.freemarker.FreeMarkerView" name="contentOptimiserTextView">
		<property name="url" value="contentoptimiser/content-optimiser-text-only.ftl" />
		<property name="contentType" value="text/html;charset=UTF-8" />
	</bean>

	<bean class="org.springframework.web.servlet.view.freemarker.FreeMarkerView" name="contentOptimiserKickoffView">
		<property name="url" value="contentoptimiser/content-optimiser-kickoff.ftl" />
		<property name="contentType" value="text/html;charset=UTF-8" />
	</bean>

	<bean class="org.springframework.web.servlet.view.freemarker.FreeMarkerView" name="contentOptimiserLoadingView">
		<property name="url" value="contentoptimiser/content-optimiser-loading.ftl" />
		<property name="contentType" value="text/html;charset=UTF-8" />
	</bean>

</beans>