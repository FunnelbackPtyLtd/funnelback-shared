<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

	<!-- logicalFilePath required so that path will be independend from where you
		 run liquibase (Maven, command line...) to avoid liquibase detecting a difference
		 in the changesets that were run -->
	<changeSet id="1" author="nguillaumin" logicalFilePath="session-db-changelog-1.0.xml">
		<createTable tableName="SearchHistory">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="userId" type="varchar(36)">
				<constraints nullable="false" />
			</column>
			<column name="collection" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="searchDate" type="timestamp">
				<constraints nullable="false" />
			</column>
			<column name="originalQuery" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="queryAsProcessed" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="totalMatching" type="int">
				<constraints nullable="false" />
			</column>
			<column name="currStart" type="int">
				<constraints nullable="false" />
			</column>
			<column name="numRanks" type="int">
				<constraints nullable="false" />
			</column>
			<column name="searchUrl" type="varchar(1024)">
				<constraints nullable="false" />
			</column>
		</createTable>
		<createIndex tableName="SearchHistory" indexName="SearchHistory_UserId_Idx">
			<column name="userId" />
		</createIndex>
		<createIndex tableName="SearchHistory" indexName="SearchHistory_Collection_Idx">
			<column name="collection" />
		</createIndex>

		<createTable tableName="ClickHistory">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="userId" type="varchar(36)">
				<constraints nullable="false" />
			</column>
			<column name="collection" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="clickDate" type="timestamp">
				<constraints nullable="false" />
			</column>
			<column name="indexUrl" type="varchar(1024)">
				<constraints nullable="false" />
			</column>
			<column name="title" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="summary" type="varchar(1024)" />
		</createTable>
		<createIndex tableName="ClickHistory" indexName="ClickHistory_UserId_Idx">
			<column name="userId" />
		</createIndex>
		<createIndex tableName="ClickHistory" indexName="ClickHistory_Collection_Idx">
			<column name="collection" />
		</createIndex>

		<createTable tableName="CartResult">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="userId" type="varchar(36)">
				<constraints nullable="false" />
			</column>
			<column name="collection" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="addedDate" type="timestamp">
				<constraints nullable="false" />
			</column>
			<column name="indexUrl" type="varchar(1024)">
				<constraints nullable="false" />
			</column>
			<column name="title" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="summary" type="varchar(1024)" />
		</createTable>
		<createIndex tableName="CartResult" indexName="CartResult_UserId_Idx">
			<column name="userId" />
		</createIndex>
		<createIndex tableName="CartResult" indexName="CartResult_Collection_Idx">
			<column name="collection" />
		</createIndex>
		<addUniqueConstraint tableName="CartResult" columnNames="userId,collection,indexUrl"/>
		

		<createTable tableName="SearchUser">
			<!-- FIXME Use proper GUID type ? Integer ? -->
			<column name="id" type="varchar(36)">
				<constraints primaryKey="true" nullable="false"></constraints>
			</column>
			<column name="email" type="varchar(255)" />
			<column name="createdDate" type="timestamp">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint referencedTableName="SearchUser"
			referencedColumnNames="id" constraintName="search_history_search_user_fk" baseColumnNames="userId"
			baseTableName="searchHistory" />

	</changeSet>

</databaseChangeLog>